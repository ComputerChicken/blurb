<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | Blurb</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="/logo.png">
</head>
<body id="body">
    <template id="tile-template">
        <div class="tile" onclick="showChat(this)">
            <img class="profile-pic">
            <div style="width:100%"></div>
            <p class="user-name"></p>
        </div>
    </template>

    <div id="tile-container"></div>

    <div id="the-bar">
        <div class="bar-image-wrapper" onclick="window.location='profile.html'" id="profile-button">
            <img class="bar-image" id="user-img">
        </div>
        <div class="bar-image-wrapper" id="home" onclick="window.location='index.html'">
            <img class="bar-image" src="home.png">
        </div>
        <div class="bar-image-wrapper" onclick="window.location='friends.html'">
            <img class="bar-image" src="friends.png">
        </div>
    </div>
</body>
<script>
    const port = 80;

    function arraysEqual(a, b) {
        return a.length === b.length &&
            a.every((val, i) => val === b[i])
    }

    async function fetchData(url) {
        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }


    const tileTemplate = document.getElementById("tile-template");
    const tileContainer = document.getElementById("tile-container");

    const friendTemplate = document.getElementById("friend-template");
    const friendsContainer = document.getElementById("friends-container");

    const requestTemplate = document.getElementById("request-template");
    const requestsContainer = document.getElementById("requests-container");
    
    const chatTemplate = document.getElementById("chat-template");
    const chats = document.getElementById("chats");

    var username = localStorage["loggedUsername"];

    if(!username) {
        window.location = "signup.html";
    }

    async function setUserPfp() {
        const pfpFilenameObject = await fetch("http://161.97.214.82:"+port+"/get-pfp-path?username="+username);
        const pfpFilename = await pfpFilenameObject.text();
        const pfpPath = "http://161.97.214.82:"+port+"/pfps/" + pfpFilename;
        document.getElementById("user-img").src = pfpPath;
    }

    setUserPfp();
    
    async function getMyUserData() {
        return await fetchData("http://161.97.214.82:"+port+"/get-user-data?user="+username);
    }

    async function addTile(tileInfo) {
        const clone = tileTemplate.content.cloneNode(true);
        
        clone.querySelector(".profile-pic").src = tileInfo.pfp;
        clone.querySelector(".tile").id = tileInfo.chatid;

        const tileChatData = await fetchData("http://161.97.214.82:"+port+"/get-chat-data?chatid="+tileInfo.chatid+"&username=none");
        clone.querySelector(".user-name").textContent = tileChatData.name[username];

        if(tileInfo.isnew) {
            clone.querySelector(".tile").style.border = "3px solid #55f"
        }
        
        tileContainer.appendChild(clone);
    }

    async function showChat(tile) {
        window.location = "chat.html?chatid=" + tile.id;
    }

    async function addChat(chatObj) {
        var pfpUser = chatObj.chatters[0];
        if(pfpUser == username) {
            pfpUser = chatObj.chatters[1];
        }
        const pfpFilenameObject = await fetch("http://161.97.214.82:"+port+"/get-pfp-path?username="+pfpUser);
        const pfpFilename = await pfpFilenameObject.text();
        const pfpPath = "http://161.97.214.82:"+port+"/pfps/" + pfpFilename;
        addTile({"pfp":pfpPath,"chatid":chatid,"isnew": isnew});
    }

    async function addFriends() {
        tileContainer.innerHTML = "";
        const myUserData = await getMyUserData();
        const userChats = [];
        const userChatsIds = [];

        for(const friend of myUserData.friends) {
            const loopChatId = await fetchData("http://161.97.214.82:"+port+"/get-chat-id?users=" + username + "," + friend);
            const chatData = await fetchData("http://161.97.214.82:"+port+"/get-chat-data?chatid="+loopChatId+"&username=none");
            chatData["id"] = loopChatId;
            userChats.push(chatData);
        }

        userChats.sort((a, b) => a.timestamp - b.timestamp);

        for(const chat of userChats) {
            var tisNew = false;
            if(myUserData.newchats.includes(chat.id)) {
                tisNew = true;
            }
            
            await addChat(chatData, tisNew);
        }
    }

    addFriends();
</script>
</html>