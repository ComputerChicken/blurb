<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up | Blurb</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="/logo.png">
</head>
<body style="overflow: hidden;">
    <div id="signup-wrapper">
        <div id="signup-container">
            <p style="font-size: 30px; margin: 0;">Sign Up</p>
            <p style="color:#f00; font-weight: 100;" id="error-text"></p>
            <input placeholder="Username" id="username">
            <input placeholder="First and last name" id="displayname">
            <input type="password" placeholder="Password" id="password">
            <input type="password" placeholder="Confirm Password" id="confirm">
            <div id="pfp-selector-wrapper">
                <label style="margin: 10px;">Choose pfp (optional): </label>
                <input type="file" id="pfp-selector">
            </div>
            <div id="rs-selector-wrapper">
                <label style="margin: 10px;">Relationship status: </label>
                <select id="rs-selector">
                    <option value="Unkown" selected>Prefer not to say</option>
                    <option value="Taken">Taken</option>
                    <option value="Single, looking for a relationship">Single, looking for a relationship</option>
                    <option value="Single, not looking for anything">Single, not looking for anything</option>
                </select>
            </div>
            <p onclick="window.location = 'signin.html'" style="margin: 0; font-size: 15px; color: #999; font-weight: 100;">Already a user? Sign In</p>
            <button onclick="sendUserData()">Alr let's go</button>
        </div>
        <br>
    </div>
</body>
<script type="module">
    const port = 80;

    import { PushNotifications } from '@capacitor/push-notifications'

    async function sendUserData() {
        var permStatus;
        try {
            permStatus = await PushNotifications.requestPermissions();
        } catch {
            permStatus = "denied";
        }

        if (permStatus.receive !== 'granted') {
            const data = {
                username: document.getElementById("username").value.toLowerCase(),
                password: document.getElementById("password").value,
                displayname: document.getElementById("displayname").value.toLowerCase().replace(/\b\w/g, s => s.toUpperCase()),
                rs: document.getElementById("rs-selector").value,
                fcm: ""
            }

            const res = await fetch("http://161.97.214.82:"+port+"/create-user", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            const resText = await res.text();

            if(resText == "true") {
                var fileList = document.getElementById("pfp-selector").files;
                console.log(fileList)
                if(fileList.length > 0) {
                    const formData = new FormData();
                    formData.append("username", document.getElementById("username").value.toLowerCase());
                    formData.append("file", fileList[0]);
                    const pfpRes = await fetch("http://161.97.214.82:"+port+"/pfp-upload", {
                        method: 'POST',
                        body: formData
                    });
                    console.log(await pfpRes.json())
                }
                console.log("created user");
                localStorage["loggedUsername"] = document.getElementById("username").value.toLowerCase();

                window.location = "index.html"
            } else {
                document.getElementById("error-text").textContent = resText;
            }
        }

        await PushNotifications.register();

        PushNotifications.addListener('registration', async token => {
            const data = {
                username: document.getElementById("username").value.toLowerCase(),
                password: document.getElementById("password").value,
                displayname: document.getElementById("displayname").value.toLowerCase().replace(/\b\w/g, s => s.toUpperCase()),
                rs: document.getElementById("rs-selector").value,
                fcm: token.value
            }

            const res = await fetch("http://161.97.214.82:"+port+"/create-user", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            const resText = await res.text();

            if(resText == "true") {
                var fileList = document.getElementById("pfp-selector").files;
                console.log(fileList)
                if(fileList.length > 0) {
                    const formData = new FormData();
                    formData.append("username", document.getElementById("username").value.toLowerCase());
                    formData.append("file", fileList[0]);
                    const pfpRes = await fetch("http://161.97.214.82:"+port+"/pfp-upload", {
                        method: 'POST',
                        body: formData
                    });
                    console.log(await pfpRes.json())
                }
                console.log("created user");
                localStorage["loggedUsername"] = document.getElementById("username").value.toLowerCase();

                window.location = "index.html"
            } else {
                document.getElementById("error-text").textContent = resText;
            }
        });
    }

    window.sendUserData = sendUserData;
</script>
</html>