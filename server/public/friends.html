<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends | Blurb</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="/logo.png">
</head>
<body id="body">
    <template id="friend-template">
        <div class="friend">
            <div class="friend-info-wrapper">
                <img class="friend-pfp">
                <div class="friend-name">Lebron</div>
            </div>
            <div class="mutual-friends">10</div>
            <button class="add-button" onclick="sendRequest(this)">Add +</button>
        </div>
    </template>

    <template id="request-template">
        <div class="request">
            <div class="request-info-wrapper">
                <img class="request-pfp">
                <div class="request-name">Lebron</div>
            </div>
            <div class="mutual-friends">10</div>
            <button class="add-button" onclick="acceptRequest(this)">Accept</button>
        </div>
    </template>

    <div id="friends-bg"></div>

    <div id="friends-wrapper">
        <div style="height:5vh; width:100vw;"></div>
        <div id="requests-container">
            <p id="requests-header">Requests</p>
        </div>
        <div id="friends-container">
            <p id="people-you-might-know">People you might know</p>
        </div>
    </div>

    <div id="the-bar">
        <div class="bar-image-wrapper" onclick="window.location='profile.html'" id="profile-button">
            <img class="bar-image" id="user-img">
        </div>
        <div class="bar-image-wrapper" id="home" onclick="window.location='index.html'">
            <img class="bar-image" src="home.png">
        </div>
        <div class="bar-image-wrapper">
            <img class="bar-image" src="friends.png">
        </div>
    </div>
</body>
<script>
    function arraysEqual(a, b) {
        return a.length === b.length &&
            a.every((val, i) => val === b[i])
    }

    async function fetchData(url) {
        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    async function getMyUserData() {
        return await fetchData("http://161.97.214.82/get-user-data?user="+username);
    }

    const friendTemplate = document.getElementById("friend-template");
    const friendsContainer = document.getElementById("friends-container");

    const requestTemplate = document.getElementById("request-template");
    const requestsContainer = document.getElementById("requests-container");

    var username = localStorage["loggedUsername"];

    if(!username) {
        window.location = "signup.html"
    }

    async function setUserPfp() {
        const pfpFilenameObject = await fetch("http://161.97.214.82/get-pfp-path?username="+username);
        const pfpFilename = await pfpFilenameObject.text();
        const pfpPath = "http://161.97.214.82/pfps/" + pfpFilename;
        document.getElementById("user-img").src = pfpPath;
    }

    setUserPfp();

    async function sendRequest(addButton) {
        fetch("http://161.97.214.82/send-request", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                requester: username,
                target: addButton.parentElement.id.replace("friendrec-","")
            })
        });
        addButton.onclick = function(){}
        addButton.textContent = "Sent!"
    }

    async function addFriendElement(friendInfo) {
        const clone = friendTemplate.content.cloneNode(true);
        
        clone.querySelector(".friend-pfp").src = friendInfo.pfp;
        clone.querySelector(".friend").id = "friendrec-" + friendInfo.username;

        clone.querySelector(".friend").visibility = "visible"

        clone.querySelector(".mutual-friends").textContent = (parseInt(friendInfo.mutuals) + Math.round(Math.random() * 2)).toString() + " mutual friends"

        const friendUserData = await fetchData("http://161.97.214.82/get-user-data?user="+friendInfo.username);
        clone.querySelector(".friend-name").textContent = friendUserData.displayname;
        
        friendsContainer.appendChild(clone);
    }

    async function addRequestElement(friendInfo) {
        console.log(friendInfo)
        const clone = requestTemplate.content.cloneNode(true);
        
        clone.querySelector(".request-pfp").src = friendInfo.pfp;
        clone.querySelector(".request").id = "friendreq-" + friendInfo.username;

        clone.querySelector(".request").visibility = "visible"

        clone.querySelector(".mutual-friends").textContent = (parseInt(friendInfo.mutuals) + Math.round(Math.random() * 2)).toString() + " mutual friends"

        const friendUserData = await fetchData("http://161.97.214.82/get-user-data?user="+friendInfo.username);
        clone.querySelector(".request-name").textContent = friendUserData.displayname;
        
        requestsContainer.appendChild(clone);
        console.log(requestsContainer)
    }

    async function addFriendRecs() {
        const allUsers = await fetchData("http://161.97.214.82/get-all-users");
        const myUserData = await getMyUserData();
        for(user of allUsers) {
            const theirUserData = await fetchData("http://161.97.214.82/get-user-data?user="+user)
            if(user != username && !myUserData.friends.includes(user) && !theirUserData.requests.includes(username)) {
                const pfpFilenameObject = await fetch("http://161.97.214.82/get-pfp-path?username="+user);
                const pfpFilename = await pfpFilenameObject.text();
                const pfpPath = "http://161.97.214.82/pfps/" + pfpFilename;

                const mutualData = await fetch("http://161.97.214.82/get-mutuals?user1=" + user + "&user2=" + username);
                const mutualText = await mutualData.text()

                addFriendElement({"pfp":pfpPath,"username":user, "mutuals":mutualText});
            }
        }
    }

    async function addFriendRequests() {
        const myUserData = await getMyUserData();
        if(myUserData.requests.length != 0) {
            document.getElementById("requests-header").style.fontSize = "15px";
        }
        for(request of myUserData.requests) {
            const theirUserData = await fetchData("http://161.97.214.82/get-user-data?user="+request)
            const pfpFilenameObject = await fetch("http://161.97.214.82/get-pfp-path?username="+request);
            const pfpFilename = await pfpFilenameObject.text();
            const pfpPath = "http://161.97.214.82/pfps/" + pfpFilename;
            const mutualData = await fetch("http://161.97.214.82/get-mutuals?user1=" + request + "&user2=" + username);
            const mutualText = await mutualData.text()

            addRequestElement({"pfp":pfpPath,"username":request, "mutuals":mutualText});
        }
    }

    async function acceptRequest(button) {
        fetch("http://161.97.214.82/accept-request", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                requester: button.parentElement.id.replace("friendreq-",""),
                target: username
            })
        });
        button.parentElement.remove()
    }
    addFriendRecs();
    addFriendRequests();
</script>
</html>